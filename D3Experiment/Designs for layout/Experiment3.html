<!DOCTYPE html>
<html>
<head>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" charset="utf-8"></script>
	<script src="../gaussian/lib/gaussian.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>


	<style>
		body{
		background-color: #fff;
		}
		.structure{
		position: absolute;
		top:0px;
		left: 0px;
		padding: 0;
		margin: 0;
		}
		
		.partContainer{
		display: flex;
		background: #eee;
		}
		
		
		.right{
		position:fixed;
		height: 1000px;
		width: 50%;
		padding-left: 10px;
		padding-top: 10px;
		background: #eee;
		}
		
		.left{
		padding-left: 7%;
		height: ;
		width:47%;
		border-right: 1px solid gray;
		//padding-left: 10px;
		padding-top: 10px;
		background:white;
		}
		
		.fixed{
			position:fixed;
			border-bottom: 1px solid #ccc;
		}
		
		.title{
			font-family: "Palatino Linotype","Book Antiqua", Palatino serif;
			padding:0;
			margin:0;
			font-weight: normal;
			padding-bottom: 10px;
		}
		.text{
		
		}
		
		.part{
			width: 90%;
			margin-left: 0;
			border-bottom: 1px solid #ccc;
			margin-top: 15px;
			padding-bottom: 30px;
		}
		
	.breadCrumbsBar {
		display: flex;
		padding: 0;
		margin: 0;
		background: #eee;
		font-size: 15px;
		box-shadow: 0px 0px 100px #ddd;
		font-family: "Palatino Linotype","Book Antiqua", Palatino serif;
		border-bottom: 1px solid #ccc;
	}
	
	.breadCrumbs li{
		list-style: none;
		display:inline;
	}
	
	.breadCrumbsDiv{
		width: 100%;
		height: 50px;
	}
	
	.progress{
		background: #eee;
		height: 0px;
		width: 100%;
		border-bottom: 1px solid #ccc;
	}
		
	.listMargin li{
		margin-top: 10px;
	}	
	
	.answer{
		width: 90%;
		margin-left: 0;
		border-bottom: 1px solid #ccc;
		margin-top: 15px;
		padding-bottom: 30px;
		color:#844B46;
	}
	
	#right{
	}
	
	</style>
</head>
<body>
	<div class="structure">
		<div class="partContainer">
			<img class="fixed" src="Header.png" style="width: 100%; height: 100px">
		</div>	
				
		<div class="partContainer">
			<img src="Header.png" style="width: 100%; height: 100px">
		</div>
			
		<div class="breadCrumbsBar">
			<div class="breadCrumbsDiv">
				<ul class="breadCrumbs">
					<li>Home |</li>
					<li>Statistics and probability |</li>
					<li><a href="./SketchHtml.html">Normal distribution</a>  |</li>
					<li><a href="./ExperimentHtml.html">Experiment 1</a>  |</li>
					<li><a href="./Experiment2Html.html">Experiment2</a>  |</li>
					<li><b>Experiment 3</b></li>
					<li><span style="padding-left:32%">Step 2 of 4</span></li>
				</ul>
			</div>

			
		</div>
		
		<div class="progress">
			<svg width="100%" height="40">

			</svg>
		</div>

		<div class="partContainer">
			<div class="left">
				<div class="part">
						<h2 class="title">Step 2 - Approximation</h2>
						<h3 class="title">General information</h3>
						Once the samples has been graphed correctly, we realize that our graph is not continuous, as it should be (because our random variable is continuous). We can make the graph continuous by approximating the our sample distribution to a known distribution. One can usually tell which known distribution to approximate to by comparing the shape of the sample distribution graph to the known distribution. In our experiment we decide to approximate to the normal distribution.
						<br><br>
						Since the normal distribution is continuous, once approximated, one can use this to cover the frequency of the range of all possible values of the random variable (even values we do not have samples on).  
						<br><br>
						To be able to calculate the density function of the normal distribution, we first need to calculate the: 
						<br><br>
						Expectation
						<br>
						Standard deviation
						<br><br>
						Once that is calculated, we can use the definition below to calculate the probability density for any value x.
				</div>
				<div class="part">
					<h3 class="title">This experiment</h3>
					Let us do the above.
					<br>					
					First we calculate the expectation of our samples:
					<br>
					[input]
					<br><br>
					Secondly we we calculate the standard deviation:
					<br>
					[input]
					<br><br>
					Lastly, we graph the probability density function on top of our previous graph.
				</div>
				<div class="answer">
					Experiments and observations
					<ol class="listMargin">
						
				
						
					<li>What happens with the sample distribution if we lower the sample size? Why does this happen?</li>
					<li>How good is the approximation of our sample distribution? </li>
					<li>What does the expectation mean. And what does the it tell us? </li>
					<li>What does the standard deviation mean. And what does it tell us?</li>
					<li>How do we know which distribution to approximate our data to?</li>
					<li>Normal distribution graph</li>
					<li>Confirm the shorthands</li>
					<ul>
						<li>68% chance that a random sample with a normal distribution to fall within 1 standard deviation from the expected value </li>
						<li>a 95% chance that it falls within 2 standard deviations from the expected value</li>
						<li>a 99% chance it falls between 3 standard deviations of the expected value</li>
					</ul>
					<li>How do you calculate the probability a person is less than 180 cm tall? (Just explain with words)</li>
					<li>What would the probability that a person is exactly 170 cm tall? </li>


						
					</ol>
				</div>
				
			</div>
			
			<div class="right" id="right">
			
					 <script>
			
			//____________________________________________________________________________
			//Initialization and variables
			var exp = 180;
			variance = 50;
			var distribution = gaussian(exp,variance);
			
			//Visuals data Svg
			var dataHeight = 70;
			
			//Visuals graph
			
				var height = 300,
				heightOffsetTop = 20,
				heightOffsetBottom = 50,
				width = 600,
				widthOffsetLeft = 50,
				widthOffsetRight = 50,
				maxY = 15;
				
			
			//limitations
			var maxN= 2000;
				maxDec= 2;
			
			//Data values	
			var	n = 200000,
				decimals = 0,
				leastValueX = exp-variance/2,
				maxValueX= exp+variance/2;
				
			var	realxrange = exp*2;
			
			var stapleWidth = (width-24)/((maxValueX-leastValueX)*Math.pow(10,decimals)),
				offsetRect = stapleWidth/2;
				
			//Colors, graph specific elements
			var	graphBGColor = "#eee",
				graphLineColor = "#ff7f0e",
				axisColor = "steelblue",
				markerColor = "steelblue";
				
			//Colors, other elements
			var circleColor = "crimson",
				coordinateTextColor = "crimson",
				cumulativeTextColor = "steelblue",
				cursorColor = "white";
				stapleAreaColor = "#ABC497";
			
			//Svg graph element to body
			var graphSvg = d3.select(".right").append("svg:svg")
				.style("background", graphBGColor)
				.attr("height", height+heightOffsetBottom)
				.attr("width", width+widthOffsetLeft+widthOffsetRight)	
		
			//Svg raw data element to body
			var dataSvg = d3.select(".right").append("svg:svg")
				.style("background", graphBGColor)
				.style("margin-left", "5px")
				.attr("height", height+heightOffsetBottom)
				.attr("width", 200+"px")	
			
			
			//DOM elements
			
			var cumulDiv = document.createElement("div");
			cumulDiv.style.height = "40px";
			cumulDiv.style.width = width+widthOffsetRight+widthOffsetRight+"px";
			cumulDiv.style.background ="#eee";
			cumulDiv.style.marginBottom = "5px"
			document.getElementById("right").appendChild(cumulDiv);	
		
			
			var divContainer = document.createElement("div");
			divContainer.style.height = "50px";
			divContainer.style.width = width+widthOffsetRight+widthOffsetRight+"px";
			divContainer.style.background ="#eee";
			document.getElementById("right").appendChild(divContainer);
				
			
			var cumulInput = document.createElement("input");
			cumulInput.id = "cumulNormalDist";
			cumulInput.type = "range";
			cumulInput.className = "input";
			cumulInput.min = leastValueX;
			cumulInput.max = maxValueX;
			cumulInput.value = leastValueX;
			cumulInput.style.margin = "10px";
			cumulInput.style.marginLeft = (widthOffsetLeft+2*offsetRect)+"px";
			cumulInput.style.width = width+"px";
			cumulInput.step = 0.01
			cumulDiv.appendChild(cumulInput);
			
			var input = document.createElement("input");
			input.id = "range";
			input.type = "range";
			input.className = "input";
			input.min = "1";
			input.max = "2000";
			input.value = "1";
			input.style.margin = "10px";
			input.style.marginLeft = widthOffsetLeft+offsetRect*2+"px"
			divContainer.appendChild(input);
			
			var inputText = document.createElement("input");
			inputText.id = "text";
			inputText.type ="text";
			inputText.size ="3";
			inputText.style.marginLeft = "10px";
			inputText.defaultValue = input.value;
			divContainer.appendChild(inputText);
			
			
			
			var sampleButton = document.createElement("button");
			sampleButton.innerHTML = "Add samples";
			sampleButton.id = "hej";
			sampleButton.style.marginLeft = "10px";
			divContainer.appendChild(sampleButton);
			
			var resetButton = document.createElement("button");
			resetButton.innerHTML = "Reset graph";
			divContainer.appendChild(resetButton);
			resetButton.style.marginLeft = "10px";
			
			var deselectStaplesButton = document.createElement("button");
			deselectStaplesButton.innerHTML = "Deselect all staples";
			divContainer.appendChild(deselectStaplesButton);
			deselectStaplesButton.style.marginLeft = "10px";
			

			
			
			
			
			//______________________________________________________________________________________________
			//Functions
			
			//Initialize dataset function
			function initData(data, decimals){
				for(i = 0; i < (maxValueX-leastValueX)*Math.pow(10,decimals); i++){
					data[i] = [i/Math.pow(10,decimals)+leastValueX, 0];
				}
				return data;
			}
			
			//GenerateData function
			function generateNewData(dataMatrix, dist, iterations, dec){
				for(i = 0; i < iterations; i++){
					var key = +(dist.ppf(Math.random())).toFixed(dec);
					var keyFound = false;
					
					dataMatrix.forEach(function(entry){
						if(entry[0] == key){
							entry[1] += 1;
							keyFound = true;
						}
					});
				//Didn't find key, create new key
					if(keyFound === false){
						dataMatrix[dataMatrix.length] = [key, 1];
					}
				}
				return dataMatrix;
			}
			
			//function actual expectancy
			function sampleMean(data, xindex, yindex){
				var totalValue = 0;
				var n = 0;
				data.forEach(function(entry){
						totalValue += entry[xindex] * entry[yindex];
						n += entry[yindex];
				})
				return totalValue/n;
			}
			
			//function actual variance
			function sampleVariance(data, xindex, yindex){
				var mean = sampleMean(data, xindex, yindex);
				var totalVariance = 0;
				var n = 0;
				data.forEach(function(entry){
					totalVariance += Math.pow(entry[xindex]-mean, 2) * entry[yindex];
					n += entry[yindex];
				});
				return totalVariance/n;
			}
			//function actual cumulative distribution
			function sampleCumulDist(data, x, xindex, yindex){
				var totalValue = 0;
				var lessThanX = 0;
				var maxvalue = 0;
				var xval = 0;
				
				data.forEach(function(entry){
					totalValue += entry[yindex];
					var test = entry[xindex];
					if(x >= entry[xindex]){
						lessThanX += entry[yindex];
						maxvalue = test;
						xval = x;
					}
				})
				return lessThanX/totalValue;
			}
			
			
			
			

			//Initialize data variable
			//__________________________________________________________________________
			var data = [];
			data = initData(data, decimals);
			//__________________________________________________________________________
			
			
			
			
			//Calculate max y value
			function getMaxY(dataMatrix){
				currentMaxY = 0;
				dataMatrix.forEach(function(entry){
					if(entry[1]>currentMaxY){
						currentMaxY = entry[1];
					}
				})
				return currentMaxY;
			}
			
			//Deselect all rects
			function deselectAllRects(){
				rects
					.attr("id", "deselected")
					.attr("fill", "transparent");
			}
			
			
		//Scale functions 
			scalex = d3.scale.linear().domain([leastValueX,maxValueX]).range([widthOffsetLeft,width+widthOffsetLeft]);
			scaley = d3.scale.linear().domain([maxY, 0]).range([heightOffsetTop,height]);
			
			scaleDistY = d3.scale.linear().domain([0.06,0]).range([heightOffsetTop,height]);
			
			//Scale from data to item size
			xRange = d3.scale.linear().domain([leastValueX,realxrange]).range([widthOffsetLeft,width+widthOffsetLeft]);
			yRange = d3.scale.linear().domain([maxY,0]).range([heightOffsetTop,height]);
			
			//Scale from item size to data
			scaleAxisX = d3.scale.linear().domain([0,width]).range([leastValueX,maxValueX]);
			scaleAxisY = d3.scale.linear().domain([heightOffsetTop,height]).range([0,maxY]);
			
			
			//Update functions
			function updateYAxis(data, axis){
				var newMaxY = getMaxY(data)+10;
				scaley = d3.scale.linear().domain([newMaxY, 0]).range([heightOffsetTop,height]);
				axis = d3.svg.axis().scale(scaley).orient("left").ticks(10);
				yax.call(axis);
				
				yax
				.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");	
				return newMaxY;
			}
			
			function updateRects(allRects, updatedData, decimals){
				
				if(getMaxY(updatedData) > maxY){
					maxY = updateYAxis(updatedData, yAxis);
					
				}
				
				allRects.data(updatedData)
					.transition()
					.duration(200)
					.attr("y", function(d){return scaley(d[1])})
					.attr("height", function(d){ return height-scaley(d[1])});
				
				updateExpText(expValueText, updatedData);
				updateSDText(sdText, updatedData);
				updateCumulText(cumulText, cumulX,updatedData);
				updateTotalX(totalX, updatedData);
				
				updateNormDist(updatedData);
				updateCPDText(normalCumulText);
				
			}
			
			//Helper function
			function getTotalData(mydata){
				var sum = 0;
				mydata.forEach(function(entry){
					sum += entry[1];
				})
				return sum;
			}
			
			
			//Staple text value
			var rectText = graphSvg.append("text")
				.attr("font-size", "12px")
				.attr("fill", "#4E633E")
				.attr("y", 15)
				
				
				
			
			//Create staples
			function createRects(smallData, decimals){

			var newRects = graphSvg.selectAll("rect.staple").data(smallData).enter().append("rect")
				.attr("class", "staple")
				.attr("x", function(d){return scalex(d[0])+offsetRect})
				.attr("y", function(d){return scaley(d[1])})
				.attr("height", function(d){ return height-scaley(d[1])})
				.attr("width", stapleWidth)
				.attr("fill", "transparent")
				.attr("stroke-width", "1px")
				.attr("stroke", "gray")
				
				.on("mouseover", function(d){
					var selection = d3.select(this)
					.attr("id");
					
					if(selection === "selected"){
						d3.select(this)
						.attr("fill", "#DEF0D1")
					}else{
						d3.select(this)
						.attr("fill","#DEF0D1")
						.attr("stroke", "#4E633E")
					}
					
					rectText
					.attr("x", scalex(d[0])+(width-24)/(maxValueX-leastValueX)-30)
					.text("x:"+d[0]+", y:"+d[1])
					.attr("opacity", 1)
					
				})
				.on("mouseleave", function(){
					var selection = d3.select(this).attr("id");
					if(selection === "selected"){
						d3.select(this)
						.attr("fill", stapleAreaColor)
						.attr("stroke", "gray")
					}else{
						d3.select(this)
						.attr("fill", "transparent")
						.attr("stroke", "gray")
					}
					rectText
					.attr("opacity", 0)
				})
				
				.on("click", function(d,i){
					deselectAllRects();
					var allrects= d3.selectAll(".staple")[0];
					for(j = 0; j <= i; j++){
						d3.select(allrects[j])
						.attr("id", "selected")
						.attr("fill", "white")
						.transition()
						.attr("fill", stapleAreaColor);
					}

					cumulX = d[0];
					updateCumulText(cumulText, cumulX, d3.selectAll(".staple").data());
					
				})
				return newRects;
			}
			
			
			//__________________________________________________________________________
			//SVG Data functions
			
			function updateExpText(text,data){
				text
				.text("Mean: "+sampleMean(data,0,1).toFixed(2));
			}
			
			function updateSDText(text, data){
				text
				.text("Standard deviation: "+ Math.sqrt(sampleVariance(data,0,1)).toFixed(2));
			}
			
			function updateCumulText(text, x, data){
				text
				.text("Cumulative distribution: "+ sampleCumulDist(data,x,0,1).toFixed(3));
			}
			
			function updateTotalX(text, data){
				text
				.text("Total samples: "+ getTotalData(data));
			}
			
			function updateCPDText(text){
				var value = scalex(cumulInput.value)+offsetRect*2;
				areaGradient.attr("x2", value);

				text
				.text("CPD Normal: " + normalDist.cdf(cumulInput.value).toFixed(3));
			}
			
			
			
			//______________________________________________________________________________________
			//SVG Data element variables
			
			
			
			var expValueText = dataSvg.append("text")
				.text("Mean: ")
				.attr("fill","black")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 20);
				
			var sdText = dataSvg.append("text")
				.text("Standard deviation: ")
				.attr("fill","black")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 50);
			
			var cumulX = 1;
				
			var cumulText = dataSvg.append("text")
				.text("Cumulative distribution: ")
				.attr("fill","black")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 80);
			
			var totalX = dataSvg.append("text")
				.text("Total samples: ")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 110);
				
			var normalCumulText = dataSvg.append("text")
				.text("CPD Normal: ")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 140);
			
			var normalX = dataSvg.append("text")
				.text("Normal x pos: ")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 170);
				
			d3.selectAll(".dataText")
				.attr("fill", axisColor)
				.attr("font-size", "12px")
			
			
			function updateNormDist(data){
				normExp = sampleMean(data, 0,1)+0.001;
				normVar = sampleVariance(data,0,1)+0.001;
				
				if(isNaN(normExp) || isNaN(normVar)){
					normExp = 1;
					normVar = 1;
				}else{
				
				}
				normalDist = gaussian(normExp, normVar);
				
				var y = normalDist.pdf(normExp)
				
				scaleDistY.domain([0,y]).range([height, scaley(getMaxY(data))]);
				
				path
				.transition()
				.duration(1000)
				.attr("d", line(data));
				
				area
				.transition()
				.duration(1000)
				.attr("d", areaSVG(data))
			}
			
			//______________________________________________________________________________________
			//Graph element variables
			
			//Path
			var normExp = 0.001
			var normVar = 0.001
			var normalDist = gaussian(normExp, normVar);
			
			//Line
			var line = d3.svg.line()
			.interpolate("cardinal")
			.x(function(d){return scalex(d[0])+offsetRect*2})
			.y(function(d){return scaleDistY(normalDist.pdf(d[0]))});
			
			var path = graphSvg.append("path")
			.attr("fill", "none")
			.attr("stroke", "black")
			.attr("stroke-width", 1)
			.attr("opacity", 0.1)
			.attr("d", line(data));
			
			//Add area gradient
			var areaGradient = graphSvg.append("linearGradient");
			 areaGradient
					.attr("id", "area-gradient")			
					.attr("gradientUnits", "userSpaceOnUse")	
					.attr("x1", 0).attr("y1", 0)			
					.attr("x2", 500).attr("y2", 0)		
				.selectAll("stop")						
					.data([								
						{offset: "99.9%", color: "#ccc"},		
						{offset: "100%", color: "transparent"},	
												])						
				.enter().append("stop")			
					.attr("offset", function(d) { return d.offset; })	
					.attr("stop-color", function(d) { return d.color; });	
			
			//Area
			var areaSVG = d3.svg.area()
				.interpolate("cardinal")
				.x(function(d) {return scalex(d[0])+offsetRect*2})
				.y0(height)
				.y1(function(d){return scaleDistY(normalDist.pdf(d[0]))});
				
			var area = graphSvg.append("path")
				.attr("id", "graphArea")
				.attr("d", areaSVG(data))
				.attr("fill", "url(#area-gradient)");
			
			
			//Initilaize rects
			var rects = createRects(data, decimals);

			//Axis
			//X
			var xAxis = d3.svg.axis().scale(scalex).orient("bottom").ticks(10);
			var xax = graphSvg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0, "+ (height)+")")
				.call(xAxis);

			xax.select("path")
				.attr("fill", "none")
				.attr("stroke", axisColor)
				.attr("shape-rendering", "crispEdges");

			xax.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");

			//Y
			var yAxis = d3.svg.axis().scale(scaley).orient("left").ticks(10);
			var yax = graphSvg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate("+ widthOffsetLeft+", 0)")
				.call(yAxis);

			yax.select("path")
				.attr("fill", "none")
				.attr("stroke", axisColor)
				.attr("shape-rendering", "crispEdges");

			yax.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");	
			
			//DOM Buttons and input
			sampleButton.onclick = function(){
				var placeHolderNumber = +d3.select("#range").property("value");
					if(getTotalData(rects.data()) + placeHolderNumber <= n){
						data = generateNewData(data, distribution, placeHolderNumber, decimals);
						updateRects(rects, data, decimals)
					}else if(getTotalData(rects.data()) < n){
						data = generateNewData(data, distribution, n-getTotalData(data), decimals);
						updateRects(rects, data, decimals)
					}else{
					
					}
					
					
				}
			
			resetButton.onclick = function(){
					data = []
					updateRects(rects, initData(data, decimals), decimals);
					maxY = updateYAxis(data, yAxis);
					deselectAllRects();
					
			}
			
			deselectStaplesButton.onclick = function(){
					deselectAllRects();
					cumulX = 0;
					updateCumulText(cumulText, cumulX, d3.selectAll(".staple").data());
					
			}
			d3.select("#range").on("input", function(){
				inputText.value = input.value;
			})
			
			console.log(d3.selectAll("#cumulNormalDist"));
			
			d3.select("#text").on("input", function(){
				input.value = inputText.value;
			})
			
			d3.select("#cumulNormalDist").on("input", function(){
				updateCPDText(normalCumulText);
				normalX.text("Normal x value: " + cumulInput.value);
			})
	
		</script>

			
			
			</div>
		</div>
	</div>
</body>