<!DOCTYPE html>
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js" charset="utf-8"></script>
	<script src="gaussian/lib/gaussian.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
  </head>
	<meta charset="utf-8">
	<title>Graph experiment</title>
</head>
	<body>
 
		 <script>
			
			
			//____________________________________________________________________________
			//Initialization and variables
			var exp = 180;
			variance = 50;
			var distribution = gaussian(exp,variance);
			
			//Visuals data Svg
			var dataHeight = 70;
			
			//Visuals graph
			
			var height = 300,
				heightOffsetTop = 20,
				heightOffsetBottom = 50,
				width = 600,
				widthOffsetLeft = 50,
				widthOffsetRight = 50,
				maxY = 15;
			
			//limitations
			var maxN= 2000;
				maxDec= 2;
			
			//Data values	
			var	n = 200000,
				decimals = 0,
				leastValueX = exp-variance/2,
				maxValueX= exp+variance/2;
				
			var	realxrange = exp*2;
			
			//Colors, graph specific elements
			var	graphBGColor = "#eee",
				graphLineColor = "#ff7f0e",
				axisColor = "steelblue",
				markerColor = "steelblue";
				
			//Colors, other elements
			var circleColor = "crimson",
				coordinateTextColor = "crimson",
				cumulativeTextColor = "steelblue",
				cursorColor = "white";
				stapleAreaColor = "#ABC497";
			
			//Svg graph element to body
			var graphSvg = d3.select("body").append("svg:svg")
				.style("background", graphBGColor)
				.attr("height", height+heightOffsetBottom)
				.attr("width", width+widthOffsetLeft+widthOffsetRight)	
			
			//Svg raw data element to body
			var dataSvg = d3.select("body").append("svg:svg")
				.style("background", graphBGColor)
				.attr("height", dataHeight)
				.attr("width", width+widthOffsetLeft+widthOffsetRight)	
			
			//DOM elements
			
			var divContainer = document.createElement("div");
			divContainer.style.height = "50px";
			divContainer.style.width = width+widthOffsetRight+widthOffsetRight+"px";
			divContainer.style.background ="#eee";
			document.body.appendChild(divContainer);
			
			
			var input = document.createElement("input");
			input.id = "range";
			input.type = "range";
			input.className = "input";
			input.min = "1";
			input.max = "2000";
			input.value = "1";
			input.style.margin = "10px";
			divContainer.appendChild(input);
			
			var inputText = document.createElement("input");
			inputText.id = "text";
			inputText.type ="text";
			inputText.size ="3";
			inputText.style.marginLeft = "10px";
			inputText.defaultValue = input.value;
			divContainer.appendChild(inputText);
			
			
			
			var sampleButton = document.createElement("button");
			sampleButton.innerHTML = "Add samples";
			sampleButton.id = "hej";
			sampleButton.style.marginLeft = "10px";
			divContainer.appendChild(sampleButton);
			
			var resetButton = document.createElement("button");
			resetButton.innerHTML = "Reset graph";
			divContainer.appendChild(resetButton);
			resetButton.style.marginLeft = "10px";
			
			var deselectStaplesButton = document.createElement("button");
			deselectStaplesButton.innerHTML = "Deselect all staples";
			divContainer.appendChild(deselectStaplesButton);
			deselectStaplesButton.style.marginLeft = "10px";
			

			
			
			
			
			//______________________________________________________________________________________________
			//Functions
			
			//Initialize dataset function
			function initData(data, decimals){
				for(i = 0; i < (maxValueX-leastValueX)*Math.pow(10,decimals); i++){
					data[i] = [i/Math.pow(10,decimals)+leastValueX, 0];
				}
				return data;
			}
			
			//GenerateData function
			function generateNewData(dataMatrix, dist, iterations, dec){
				for(i = 0; i < iterations; i++){
					var key = +(dist.ppf(Math.random())).toFixed(dec);
					var keyFound = false;
					
					dataMatrix.forEach(function(entry){
						if(entry[0] == key){
							entry[1] += 1;
							keyFound = true;
						}
					});
				//Didn't find key, create new key
					if(keyFound === false){
						dataMatrix[dataMatrix.length] = [key, 1];
					}
				}
				return dataMatrix;
			}
			
			//function actual expectancy
			function sampleMean(data, xindex, yindex){
				var totalValue = 0;
				var n = 0;
				data.forEach(function(entry){
						totalValue += entry[xindex] * entry[yindex];
						n += entry[yindex];
				})
				return totalValue/n;
			}
			
			//function actual variance
			function sampleVariance(data, xindex, yindex){
				var mean = sampleMean(data, xindex, yindex);
				var totalVariance = 0;
				var n = 0;
				data.forEach(function(entry){
					totalVariance += Math.pow(entry[xindex]-mean, 2) * entry[yindex];
					n += entry[yindex];
				});
				return totalVariance/n;
			}
			//function actual cumulative distribution
			function sampleCumulDist(data, x, xindex, yindex){
				var totalValue = 0;
				var lessThanX = 0;
				var maxvalue = 0;
				var xval = 0;
				
				data.forEach(function(entry){
					totalValue += entry[yindex];
					var test = entry[xindex];
					if(x >= entry[xindex]){
						lessThanX += entry[yindex];
						maxvalue = test;
						xval = x;
					}
				})
				return lessThanX/totalValue;
			}
			
			
			
			

			//Initialize data variable
			//__________________________________________________________________________
			var data = [];
			data = initData(data, decimals);
			//__________________________________________________________________________
			
			
			
			
			//Calculate max y value
			function getMaxY(dataMatrix){
				currentMaxY = 0;
				dataMatrix.forEach(function(entry){
					if(entry[1]>currentMaxY){
						currentMaxY = entry[1];
					}
				})
				return currentMaxY;
			}
			
			//Deselect all rects
			function deselectAllRects(){
				rects
					.attr("id", "deselected")
					.attr("fill", "transparent");
			}
			
			
		//Scale functions 
			scalex = d3.scale.linear().domain([leastValueX,maxValueX]).range([widthOffsetLeft,width+widthOffsetLeft]);
			scaley = d3.scale.linear().domain([maxY, 0]).range([heightOffsetTop,height]);
			
			//Scale from data to item size
			xRange = d3.scale.linear().domain([leastValueX,realxrange]).range([widthOffsetLeft,width+widthOffsetLeft]);
			yRange = d3.scale.linear().domain([maxY,0]).range([heightOffsetTop,height]);
			
			//Scale from item size to data
			scaleAxisX = d3.scale.linear().domain([0,width]).range([leastValueX,maxValueX]);
			scaleAxisY = d3.scale.linear().domain([heightOffsetTop,height]).range([0,maxY]);
			
			
			//Update functions
			function updateYAxis(data, axis){
				var newMaxY = getMaxY(data)+10;
				scaley = d3.scale.linear().domain([newMaxY, 0]).range([heightOffsetTop,height]);
				axis = d3.svg.axis().scale(scaley).orient("left").ticks(10);
				yax.call(axis);
				
				yax
				.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");	
				return newMaxY;
			}
			
			function updateRects(allRects, updatedData, decimals){
				
				if(getMaxY(updatedData) > maxY){
					maxY = updateYAxis(updatedData, yAxis);
					
				}
				
				allRects.data(updatedData)
					.transition()
					.duration(200)
					.attr("y", function(d){return scaley(d[1])})
					.attr("height", function(d){ return height-scaley(d[1])});
				
				updateExpText(expValueText, updatedData);
				updateSDText(sdText, updatedData);
				updateCumulText(cumulText, cumulX,updatedData);
				updateTotalX(totalX, updatedData);
				
			}
			
			//Helper function
			function getTotalData(mydata){
				var sum = 0;
				mydata.forEach(function(entry){
					sum += entry[1];
				})
				return sum;
			}
			
			
			//Staple text value
			var rectText = graphSvg.append("text")
				.attr("font-size", "12px")
				.attr("fill", "#4E633E")
				.attr("y", 15)
				
				
				
			
			//Create staples
			function createRects(smallData, decimals){
			var stapleWidth = (width-24)/((maxValueX-leastValueX)*Math.pow(10,decimals));
			var newRects = graphSvg.selectAll("rect.staple").data(smallData).enter().append("rect")
				.attr("class", "staple")
				.attr("x", function(d){return scalex(d[0])+stapleWidth/2})
				.attr("y", function(d){return scaley(d[1])})
				.attr("height", function(d){ return height-scaley(d[1])})
				.attr("width", stapleWidth)
				.attr("fill", "transparent")
				.attr("stroke-width", "1px")
				.attr("stroke", "gray")
				
				.on("mouseover", function(d){
					var selection = d3.select(this)
					.attr("id");
					
					if(selection === "selected"){
						d3.select(this)
						.attr("fill", "#DEF0D1")
					}else{
						d3.select(this)
						.attr("fill","#DEF0D1")
						.attr("stroke", "#4E633E")
					}
					
					rectText
					.attr("x", scalex(d[0])+(width-24)/(maxValueX-leastValueX)-30)
					.text("x:"+d[0]+", y:"+d[1])
					.attr("opacity", 1)
					
				})
				.on("mouseleave", function(){
					var selection = d3.select(this).attr("id");
					if(selection === "selected"){
						d3.select(this)
						.attr("fill", stapleAreaColor)
						.attr("stroke", "gray")
					}else{
						d3.select(this)
						.attr("fill", "transparent")
						.attr("stroke", "gray")
					}
					rectText
					.attr("opacity", 0)
				})
				
				.on("click", function(d,i){
					deselectAllRects();
					var allrects= d3.selectAll(".staple")[0];
					for(j = 0; j <= i; j++){
						d3.select(allrects[j])
						.attr("id", "selected")
						.attr("fill", "white")
						.transition()
						.attr("fill", stapleAreaColor);
					}

					cumulX = d[0];
					updateCumulText(cumulText, cumulX, d3.selectAll(".staple").data());
					
				})
				return newRects;
			}
			
			
			//__________________________________________________________________________
			//SVG Data functions
			
			function updateExpText(text,data){
				text
				.text("Sample mean: "+sampleMean(data,0,1).toFixed(2));
			}
			
			function updateSDText(text, data){
				text
				.text("Sample standard deviation: "+ Math.sqrt(sampleVariance(data,0,1)).toFixed(2));
			}
			
			function updateCumulText(text, x, data){
				text
				.text("Sample cumulative distribution: "+ sampleCumulDist(data,x,0,1).toFixed(3));
			}
			
			function updateTotalX(text, data){
				text
				.text("Total samples: "+ getTotalData(data));
			}
			
			//______________________________________________________________________________________
			//SVG Data element variables
			
			var expValueText = dataSvg.append("text")
				.text("Sample mean: ")
				.attr("fill","black")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 20);
				
			var sdText = dataSvg.append("text")
				.text("Sample standard deviation: ")
				.attr("fill","black")
				.attr("x", 300)
				.attr("class", "dataText")
				.attr("y", 20);
			
			var cumulX = 1;
				
			var cumulText = dataSvg.append("text")
				.text("Sample cumulative distribution: ")
				.attr("fill","black")
				.attr("x", 20)
				.attr("class", "dataText")
				.attr("y", 50);
			
			var totalX = dataSvg.append("text")
				.text("Total samples: ")
				.attr("x", 300)
				.attr("class", "dataText")
				.attr("y", 50);
			
			d3.selectAll(".dataText")
				.attr("fill", axisColor)
				.attr("font-size", "12px")
			
			
			//______________________________________________________________________________________
			//Graph element variables
			//Axis
			//X
			
			//Initilaize rects
			var rects = createRects(data, decimals);
			
			var xAxis = d3.svg.axis().scale(scalex).orient("bottom").ticks(10);
			var xax = graphSvg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate(0, "+ (height)+")")
				.call(xAxis);

			xax.select("path")
				.attr("fill", "none")
				.attr("stroke", axisColor)
				.attr("shape-rendering", "crispEdges");

			xax.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");

			//Y
			var yAxis = d3.svg.axis().scale(scaley).orient("left").ticks(10);
			var yax = graphSvg.append("g")
				.attr("class", "axis")
				.attr("transform", "translate("+ widthOffsetLeft+", 0)")
				.call(yAxis);

			yax.select("path")
				.attr("fill", "none")
				.attr("stroke", axisColor)
				.attr("shape-rendering", "crispEdges");

			yax.selectAll("text")
				.attr("fill",axisColor)
				.attr("font-size", "10px");	

	/**		//Big tick line, shows mean
			var sampleEx = sampleMean(data, 0, 1);
			var tickline = graphSvg.append("svg:line")
				.attr("stroke", axisColor)
				.attr("stroke-width", 3)
				.attr("x1", scalex(sampleEx))
				.attr("x2", scalex(sampleEx))
				.attr("y1", height)
				.attr("y2", height);
			//Animation
			tickline
				.transition()
				.delay(1300)
				.attr("y1", height+6)
				.attr("y2", height-6);
			
			//Two small ticks, shows standard deviation	
			//Tick 1
			var sampleVar = sampleVariance(data, 0,1);
			var smalltick = graphSvg.append("svg:line")
				.attr("stroke", axisColor)
				.attr("stroke-width", 1)
				.attr("x1", scalex(sampleEx-Math.sqrt(sampleVar)))
				.attr("x2", scalex(sampleEx-Math.sqrt(sampleVar)))
				.attr("y1", height)
				.attr("y2", height);
			//Animation
			smalltick
				.transition()
				.delay(1700)
				.attr("y1", height+5)
				.attr("y2", height-5);	
				
			//Tick 2	
			var smalltick2 = graphSvg.append("svg:line")
				.attr("stroke", axisColor)
				.attr("stroke-width", 1)
				.attr("x1", scalex(sampleEx+Math.sqrt(sampleVar)))
				.attr("x2", scalex(sampleEx+Math.sqrt(sampleVar)))
				.attr("y1", height)
				.attr("y2", height);
			//Animation
			smalltick2
				.transition()
				.delay(1700)
				.attr("y1", height+5)
				.attr("y2", height-5);	
			**/
			

			
			sampleButton.onclick = function(){
				var placeHolderNumber = +d3.select(".input").property("value");
					if(getTotalData(rects.data()) + placeHolderNumber <= n){
						data = generateNewData(data, distribution, placeHolderNumber, decimals);
						updateRects(rects, data, decimals)
					}else if(getTotalData(rects.data()) < n){
						data = generateNewData(data, distribution, n-getTotalData(data), decimals);
						updateRects(rects, data, decimals)
					}else{
					
					}
					
					
				}
			
			resetButton.onclick = function(){
					var emptyData = []
					updateRects(rects, initData(data, decimals), decimals);
					maxY = updateYAxis(data, yAxis);
					deselectAllRects();
					
			}
			
			deselectStaplesButton.onclick = function(){
					deselectAllRects();
					cumulX = 0;
					updateCumulText(cumulText, cumulX, d3.selectAll(".staple").data());
					
			}
			d3.select("#range").on("input", function(){
				inputText.value = input.value;
			})
			
			d3.select("#text").on("input", function(){
				input.value = inputText.value;
			})
			
			
			
		
			
		</script>
	</body>
</html>